<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8" />
        <title>Twister</title>
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <link rel="stylesheet" type="text/css" media="screen" href="css/Principale.css" />
        <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    </head>
<body onload="init()">
    
</body>

<script type="text/javascript">
    
    /* ############################ */
    /* Classes JavaScript du projet */
    /* ############################ */

    //Objet Message
    function Message(id , auteur , texte , comments , date){
        this.id = id;
        this.auteur=auteur;
        this.date=date;
        this.texte=texte;
        if(comments == undefined){
            comments=[];}
        this.comments=comments;
    }
    Message.prototype.getHTML = function(){
        s="<div id=\"message_"+this.id+"\" class=\"msg\" >"+
            "<img class='expand' style='cursor:pointer;' src='image/plus_logo.png' onclick='javascript:(function (){console.log(\"Jason\")})()'/>"+
            "<div>"+
                "<div>"+this.auteur.getHTML()+"</div>"+
                "<div>"+this.date+"</div>"+
            "</div>"+
            "<div>"+this.texte+"</div>"+
            "<div class = \"comments\">"+
            "</div>"
        "</div>";
        return s;
    }

    //objet commentaire
    function Commentaire(id , auteur , texte , date){
        this.id = id;
        this.auteur=auteur;
        this.date=date;
        this.texte=texte;
    }
    Commentaire.prototype.getHTML = function(){
        s="<div id=\"commentaire_"+this.id+"\">"+
            "<div><div>"+this.auteur.getHTML()+"</div><div>"+this.date+"</div></div>"+
            "<div>"+this.texte+"</div>"+
            "</div>";
        return s;
    }

    //objet Auteur
    function Auteur(id , login){
        this.id = id;
        this.login=login;
    }
    Auteur.prototype.getHTML = function(){
        s="<div id=\"auteur_"+this.id+"\">"+
            "<div>"+this.login+"</div>"+
            "</div>";
        return s;
    }

    //fonction du parser
    revival=function(key , value){
        if(!value.comments == undefined){
            return new Message(value.id , valu.auteur, value.texte , value.date , value.comments);
        }
        else if(value.texte != undefined){
            return new Commentaire(value.id , value.auteur ,value.texte, value.date);
        }
        if(key=="auteur"){
            return new Auteur(value.id , value.login);
        }
        if(key=="date"){
            return new date(value.date);
        }
    }

    function setVirtualdb(){
        localdb= []
        follows = []
        /*var u1 = {"id":1 , "login":"toto"}
        var u2 = {"id":2 , "login":"titi"}
        var u3 = {"id":3 , "login":"jordan"}*/

        var u1 = new Auteur(1, "toto");
        var u2 = new Auteur(2, "tata");
        var u3 = new Auteur(3, "jordan");

        follows[1] = new Set()
        follows[1].add(2)
        follows[2] = new Set()
        follows[2].add(3)
        follows[3] = new Set()
        follows[3].add(1)

        com1 = new Commentaire(1, u2, "Comment ca va", new Date());
        com2 =  new Commentaire(2, u3, "Ca va bien", new Date());

        msg = new Message( 1 , u1 , "yo !" , [com1 , com2] , new Date());

        localdb[0] = msg;
    }

    function init()
    {
        noConnection = true;
        env = new Object();
        env.key = "abcd";
        env.idUser = 1;
        setVirtualdb();

        makeMainPanel(0,0,0);
        var c = localdb[0].getHTML();
        
        $("#messages").append(c);
        $("#messages").append(c);
    }

    /* ############################# */
    /* Fonction de cr√©ation de panel */
    /* ############################# */
    function makeForgottenPwdPanel(){
        $("link").attr("href", "css/Connexion.css")
        $.ajax({
            url: 'Forgotten_Pwd.html',
            dataType: 'html',
            async: false,
            success: function(data)
            {
                $("body").html(data);
            }
            });
    }
    
    function makeInscriptionPanel(){
        $("link").attr("href", "css/Inscription.css")
        $.ajax({
            url: 'Inscription.html',
            dataType: 'html',
            async: false,
            success: function(data)
            {
                $("body").html(data);
            }
            });
    }

    function makeConnexionPanel(){
        $("link").attr("href", "css/Connexion.css")
        $.ajax({
            url: 'Connexion.html',
            dataType: 'html',
            async: false,
            success: function(data)
            {
                $("body").html(data);
            }
            });
    }

    function makeMainPanel(fromId , fromLogin , query){
        env.message = []
        if(fromId == undefined){
            fromId = -1
        }
        env.fromLogin = fromLogin;

        $("link").attr("href", "css/Principale.css")
        $.ajax({
            url: 'tampon.html',
            dataType: 'html',
            async: false,
            success: function(data)
            {
                $("body").html(data);
            }
            });
    }

    /* ################################## */
    /* Gestion affichage des commentaires */
    /* ################################## */
    function developpeMessage(id)
    {
        console.log("On developpe le message");
        var m = env.msg[id];
        var el = $("#message_"+id);
        for(var i=0; i<m.comments.length; i++)
        {
            var c = m.comments[i];
            el.append(c.getHTML());
        }

        el = $("#message_"+id+" .new_comment");
        el.append("<p> ECRIT LE CODE POUR ECKRIR 1 COMM</p>>");
        $("#message_"+id+" img" ).replaceWith("<img style=\"cursor:pointer;\" src=\"image/minus_logo.png\" onclick=\"javascript:repliMessage("+id+")\"")
    }

    function replieMessage(id)
    {
        console.log("On remplie le message");
        var el = $("#message_"+id+" .comments");
        el.html("");
        $("#message_"+id+" img" ).replaceWith("<img style=\"cursor:pointer;\" src=\"image/plus_logo.png\" onclick=\"javascript:developpeMessage("+id+")\"")
    }

</script>
</html>